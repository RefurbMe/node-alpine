machine:
  services:
    - docker
  pre:
    - echo 'export TAG_NAME=$CIRCLE_BRANCH' >> ~/.circlerc
    - echo 'export IMAGE_NAME=${CIRCLE_PROJECT_USERNAME,,}/${CIRCLE_PROJECT_REPONAME,,}' >> ~/.circlerc

dependencies:
  override:
    - docker build -t $IMAGE_NAME:$TAG_NAME .

test:
  override:
    - docker run $IMAGE_NAME node -v
    - docker run $IMAGE_NAME npm -v
    - docker images | grep $IMAGE_NAME

deployment:
  hub:
    branch: /node\-*/
    commands:
      - sudo pip install docker-scripts
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker-scripts squash $IMAGE_NAME:$TAG_NAME
      - docker images | grep $IMAGE_NAME
      - docker push $IMAGE_NAME:$TAG_NAME
